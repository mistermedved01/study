# Балансировка

## Уровни балансировки 

Процедура балансировки осуществляется при помощи комплекса алгоритмов и методов, соответствующих следующим уровням модели OSI: 
- сетевой (L3);
- транспортный (L4);
- прикладной (L7).

![Alt-текст](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/02_%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8/img/balance_00.jpg)

### Сетевой уровень (L3)

Балансировка на сетевом уровне предполагает решение следующей задачи: нужно сделать так, чтобы за один конкретный IP-адрес сервера отвечали разные физические машины. Такая балансировка может осуществляться с помощью множества разнообразных способов.

- DNS-балансировка — выделение сразу нескольких IP-адресов для одного доменного имени. Основывается на алгоритмах, как правило, Round Robin. Принцип работы: на одно DNS-имя выделяется несколько IP-адресов. Алгоритм позволяет перенаправлять трафик в зависимости от нагрузки серверов.

- Создание NLB-кластера — объединение нескольких серверов в единый кластер из входных и вычислительных узлов с последующей балансировкой нагрузки в соответствии со специальным алгоритмом. Используется в решениях от компании Microsoft. Несколько физических серверов объединяют в кластер, состоящий из входных и вычислительных узлов. 

- Балансировка по IP с использованием дополнительного маршрутизатора. В сети размещают несколько точек входа к сервису, и трафик распараллеливается между маршрутами.
  
- По территориальному признаку — при этом способе балансировки размещается сразу несколько «клонов» сервиса с идентичными адресами, но каждый — в отдельном регионе интернета. Кстати, на базе такого метода работают многие сети доставки контента. Наиболее активно он используется в сервисах с огромным количеством пользователей из разных стран и даже континентов.

**Балансировка на сетевом уровне — надежный, но дорогостоящий способ выровнять нагрузку на сервер.**

**К сетевому уровню относятся решения, которые не терминируют на себе пользовательские сессии. Они просто перенаправляют трафик и не работают в проксирующем режиме.** 

**На сетевом уровне балансировщик решает, на какой сервер передавать пакеты. Сессию с клиентом осуществляет сервер.**

### Транспортный уровень (L4)

Клиент обращается к балансировщику, тот перенаправляет запрос одному из серверов, который и будет его обрабатывать. Общение с клиентом замыкается на балансировщике, который работает как прокси. Он взаимодействует с серверами от своего имени, передавая информацию о клиенте в дополнительных данных и заголовках.

Решение - популярный балансировщик HAProxy.

**В чем принципиальная разница между сетевыми и транспортными методами? Первые просто перенаправляют запросы. Затем выбранный сервер напрямую обменивается данными с клиентом. Транспортные методы работают как прокси — они сами обмениваются данными с сервером, а не связывают клиента и сервер напрямую.**

### Прикладной уровень (L7)

При балансировке на прикладном уровне балансировщик работает в режиме «умного прокси». Он анализирует клиентские запросы и перенаправляет их на разные серверы в зависимости от характера запрашиваемого контента. Так работает, например, веб-сервер Nginx, распределяя запросы между фронтендом и бэкендом. За балансировку в Nginx отвечает модуль Upstream.

**HAProxy или Nginx с модулем Upstream** - позволяют балансировать нагрузку на L4 и L7 и проверять работоспособность узлов, для вывода их из балансировки в случае неисправности.

## Типы балансировки нагрузки

Балансировщики нагрузки различаются по типу хранилища, сложности и функциональности балансировщика. Ниже описаны различные типы балансировщиков нагрузки.

1. Аппаратное обеспечение (Hardware-Based)

Аппаратный балансировщик нагрузки - это специализированное оборудование с установленным проприетарным программным обеспечением. Он может обрабатывать большие объемы трафика от различных типов приложений.
Аппаратные балансировщики нагрузки содержат встроенные возможности виртуализации, которые позволяют использовать несколько экземпляров виртуального балансировщика нагрузки на одном устройстве.

**Примеры аппаратных балансировщиков нагрузки:**

- F5 BIG-IP: F5 BIG-IP является одним из самых известных и распространенных аппаратных балансировщиков нагрузки. Он предлагает широкий спектр функций, таких как балансировка нагрузки, SSL-терминирование, защита от DDoS-атак, а также возможности управления и мониторинга трафика.
- Citrix ADC (ранее известный как NetScaler) - предлагает широкий спектр функциональных возможностей для обеспечения высокой доступности и производительности веб-приложений и служб. Он также включает в себя функции управления трафиком, оптимизацию приложений и защиту от угроз безопасности.
- Cisco Application Control Engine (ACE) - предлагает высокую производительность и надежность при распределении трафика между серверами. Он также поддерживает различные протоколы и методы балансировки нагрузки, такие как round-robin и least connections.
- Barracuda Load Balancer - это еще один пример аппаратного балансировщика нагрузки, который обеспечивает распределение трафика, управление бандвидтом и защиту от угроз в одном устройстве. Он поддерживает различные протоколы и методы балансировки нагрузки для обеспечения высокой доступности и производительности приложений.

**Примеры аппаратных фаерволов с функцией балансировки нагрузки:**

- Cisco ASA с модулем ACE - это многофункциональное устройство безопасности, которое может быть дополнено модулем ACE (Application Control Engine). Модуль ACE предоставляет возможности балансировки нагрузки, а также служит для управления трафиком и оптимизации производительности приложений.
- Fortinet FortiGate - предлагает функции балансировки нагрузки в рамках своих многофункциональных возможностей. Он обеспечивает защиту от угроз и атак, а также помогает оптимизировать работу сети и приложений.
- Palo Alto Networks PA-Series - включают в себя функциональность балансировки нагрузки. Они предлагают передовые возможности обнаружения и предотвращения угроз, а также помогают оптимизировать производительность приложений и доступность сервисов.
- Barracuda NextGen Firewall - это аппаратный файервол, который включает в себя функции балансировки нагрузки для оптимизации работы сети и обеспечения надежности сервисов.

2. Программное обеспечение (Software-Based)

Этот тип балансировки нагрузки реализуется на уровне программного обеспечения и запускается на физическом или виртуальном сервере. Программное обеспечение, такое как NGINX, HAProxy и Apache, может выполнять функции балансировки нагрузки, а также другие функции, такие как обработка HTTP-запросов, кэширование и защита от атак.

**Примеры:**

- NGINX - это высокопроизводительный веб-сервер и прокси-сервер с встроенной функциональностью балансировки нагрузки. Он широко используется для обеспечения высокой доступности и производительности веб-приложений.
- HAProxy - это бесплатный и открытый программный балансировщик нагрузки для TCP и HTTP-сервисов. Он обеспечивает высокую производительность, надежность и гибкость конфигурации.
- Apache HTTP Server с модулем mod_proxy_balancer: Apache HTTP Server - это один из самых распространенных веб-серверов, который также может использоваться в качестве балансировщика нагрузки с помощью модуля mod_proxy_balancer. Этот модуль добавляет функциональность балансировки нагрузки к Apache, позволяя распределять трафик между несколькими серверами.
- Traefik - это открытое программное обеспечение, представляющее собой современный HTTP reverse proxy и балансировщик нагрузки, специально разработанный для работы в контейнерных средах, таких как Docker и Kubernetes.

3. Облачная (Cloud-Based)

Облачная балансировка нагрузки использует облачную инфраструктуру. Вот некоторые примеры облачной балансировки нагрузки:

- Балансировка сетевой нагрузки. Балансировка сетевой нагрузки основана на уровне 4 и использует информацию сетевого уровня, чтобы определить, куда отправлять сетевой трафик. Это самое быстрое решение для балансировки нагрузки, но ему не хватает балансировки распределения трафика между серверами.
- Балансировка нагрузки HTTP(S). Балансировка нагрузки HTTP(S) основана на уровне 7. Это один из наиболее гибких типов балансировки нагрузки, позволяющий администраторам принимать решения о распределении трафика на основе любой информации, поступающей с адресом HTTP.
- Внутренняя балансировка нагрузки. Внутренняя балансировка нагрузки почти идентична балансировке сетевой нагрузки, за исключением того, что она может балансировать распределение во внутренней инфраструктуре.

Примеры:

Elastic Load Balancing - это сервис балансировки нагрузки от Amazon Web Services (AWS), который предоставляет управляемое решение для распределения трафика между экземплярами Amazon EC2, контейнерами и другими ресурсами AWS.

## Алгоритмы балансировки нагрузки

**Алгоритм балансировки нагрузки** – это набор правил, которым следует балансировщик нагрузки для определения наилучшего сервера для каждого из различных клиентских запросов. Алгоритмы балансировки нагрузки делятся на две основные категории.

**1. Статические алгоритмы балансировки нагрузки.**

Следуют фиксированным правилам и не зависят от текущего состояния сервера.

**Round Robin**

**Round Robin** - это один из классических алгоритмов балансировки нагрузки, который базируется на простой и эффективной идее: запросы от клиентов равномерно распределяются между серверами в циклическом порядке. Этот алгоритм был разработан исключительно для обеспечения равномерной нагрузки на серверы и минимизации времени ожидания ответа клиента.

![Alt-текст](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/02_%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8/img/round_robin.jpg)

Round Robin был одним из первых алгоритмов балансировки нагрузки и использовался в сетях даже до развития веб-приложений. Его суть заключается в том, что каждый новый запрос направляется на следующий сервер в кольце серверов, и при достижении конца списка серверов процесс начинается снова. Это гарантирует, что нагрузка распределяется равномерно, что особенно важно, когда серверы имеют одинаковые характеристики и могут обрабатывать запросы одинаково быстро.Round Robin прост в реализации и обеспечивает базовую балансировку нагрузки.

Однако, при использовании данного алгоритма, не учитывается актуальное состояние серверов или их производительность. Если один из серверов становится недоступным или медленным, алгоритм продолжит направлять к нему запросы, что может привести к неэффективному использованию ресурсов.

Преимущества:

- Простота реализации: один из самых простых алгоритмов балансировки нагрузки, и его легко внедрить.
- Равномерное распределение: обеспечивает равномерное распределение нагрузки на сервера, что делает его хорошим выбором для сценариев, где серверы имеют схожую производительность.

Недостатки:

- Не учитывает состояние серверов: не учитывает актуальное состояние серверов, поэтому даже недоступные серверы продолжат получать запросы.
- Не реагирует на нагрузку: не учитывает текущую нагрузку на серверы, что может привести к перегрузке некоторых серверов, особенно если они обрабатывают запросы медленнее других.
Ограниченный вариант: может быть менее подходящим для сценариев, где серверы имеют различную производительность или актуальное состояние серверов критично.

**Weighted Round Robin**

Это — усовершенствованная версия алгоритма Round Robin. Суть усовершенствований заключается в следующем: каждому серверу присваивается весовой коэффициент в соответствии с его производительностью и мощностью. Это помогает распределять нагрузку более гибко: серверы с большим весом обрабатывают больше запросов. Однако всех проблем с отказоустойчивостью это отнюдь не решает. Более эффективную балансировку обеспечивают другие методы, в которых при планировании и распределении нагрузки учитывается большее количество параметров.

**IP Hash**

Алгоритм IP Hash – это метод балансировки нагрузки, который основан на IP-адресе клиента. Этот метод определяет сервер, на который следует направить запрос, исходя из IP-адреса клиента. Таким образом, одному и тому же клиенту всегда будет назначен один и тот же сервер, что позволяет сохранить состояние между запросами от одного и того же клиента.

![Alt-текст](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/02_%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8/img/ip_hash.jpg)

Работа алгоритма IP Hash следующая:

Для каждого входящего запроса определяется IP-адрес клиента.

Применяется хеш-функция к IP-адресу, чтобы получить числовое значение (хеш).

Хеш значение используется для выбора сервера из пула серверов. Обычно используется операция взятия остатка от деления хеша на количество серверов.

IP Hash может быть особенно полезным в сценариях, где необходимо поддерживать сессию между клиентом и сервером. Например, в веб-приложениях, где пользователь должен оставаться на одном и том же сервере для сохранения состояния в течение сеанса.

**Преимущества:**

- Сохранение состояния: IP Hash обеспечивает сохранение состояния между клиентом и сервером, что делает его подходящим для сценариев, требующих управления сессиями и кеширования.
- Постоянная маршрутизация: Клиент всегда будет направляться на один и тот же сервер, что полезно для устойчивости и непрерывности обслуживания клиентов.

**Недостатки:**

- Ограничения масштабирования: IP Hash может ограничивать масштабирование, так как клиенты будут всегда маршрутизироваться на один и тот же сервер, что может создавать дисбаланс нагрузки.
- Особенности прокси и балансировщиков: В некоторых случаях, использование балансировщиков или прокси-серверов может затруднить применение IP Hash.

2. Динамические алгоритмы балансировки нагрузки.

Адаптируются к изменяющимся условиям в сети или на серверах и принимают решения о распределении трафика в реальном времени на основе текущей нагрузки, доступности серверов и других факторов.

**Least Connections (Наименьшее количество подключений)**

Least Connections - это алгоритм балансировки нагрузки, который призван выбирать сервер с наименьшим активным соединением из числа доступных серверов.

![Alt-текст](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/02_%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8/img/least_connections.jpg)

Этот алгоритм ориентирован на учет текущей нагрузки на серверы и позволяет маршрутизировать запросы к серверам, у которых наименьшая нагрузка.

Работа алгоритма состоит в следующем:

1. При поступлении нового запроса, балансировщик нагрузки анализирует количество активных соединений на каждом из серверов в пуле.
2. Запрос направляется на сервер с наименьшим количеством активных соединений.
3. Счетчик активных соединений обновляется.

Least Connections является более интеллектуальным алгоритмом по сравнению с Round Robin, так как он учитывает текущую нагрузку на серверы, позволяя эффективно распределять запросы даже в ситуациях, где серверы имеют разную производительность.

**Преимущества:**

- Эффективное распределение нагрузки: Обеспечивает более равномерное распределение нагрузки на серверы, что делает его подходящим для сценариев, где серверы имеют разную производительность.
- Учет активных соединений: Алгоритм учитывает актуальное состояние серверов и направляет запросы к серверу с наименьшим количеством активных соединений, что уменьшает вероятность перегрузки.

**Недостатки:**

- Сложность реализации: может потребовать сложных механизмов учета активных соединений на серверах.
- Отсутствие учета производительности серверов: учитывает только количество активных соединений, но не учитывает производительность серверов, что может привести к неоптимальному распределению нагрузки в некоторых случаях.

**Weighted Least Connections**

Существует усовершенствованный вариант этого алгоритма, предназначенный в первую очередь для использования в кластерах, состоящих из серверов с разными техническими характеристиками и разной производительностью. Он называется Weighted Least Connections и учитывает при распределении нагрузки не только количество активных подключений, но и весовой коэффициент серверов.
В числе других усовершенствованных вариантов алгоритма Least Connections следует прежде всего выделить Locality-Based Least Connection Scheduling и Locality-Based Least Connection Scheduling with Replication Scheduling.

**Least Response Time (Наименьшее время отклика)**

Балансировка нагрузки с наименьшим временем отклика распределяет запросы на сервер с наименьшим количеством активных подключений и с самым быстрым средним временем отклика на запрос мониторинга работоспособности. Скорость отклика показывает, насколько загружен сервер.

![Alt-текст](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/02_%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8/img/last_response_time.jpg)

**Resource-based method**

В методе на основе ресурсов балансировщики нагрузки распределяют трафик, анализируя текущую загрузку сервера. Специализированное программное обеспечение, называемое агентом, работает на каждом сервере и рассчитывает использование ресурсов сервера, таких как его вычислительная мощность и память. Затем балансировщик нагрузки проверяет агента на наличие достаточных свободных ресурсов перед распределением трафика на этот сервер.


