# FHRP (First Hop Redundancy Protocols)

**FHRP (Протокол резервирования первого перехода)** - это семей­ство сетевых про­токо­лов, которые позволяют нескольким физическим маршрутизторам делить/обслуживать один виртуальный IP-адрес, с целью повышения отказоустойчивости локальной сети. Этот виртуальный адрес будет наз­начать­ся, как адрес шлюза по умолчанию для конечных хостов. Обеспечивает механизм резервирования, чтобы одно или несколько устройств могли быть готовы взять на себя функции шлюза по умолчанию в случае отказа текущего активного устройства.

![Название скриншота 0](https://github.com/mistermedved01/study/blob/master/%D0%9E%D1%82%D0%BA%D0%B0%D0%B7%D0%BE%D1%83%D1%81%D1%82%D0%BE%D0%B9%D1%87%D0%B8%D0%B2%D0%BE%D1%81%D1%82%D1%8C_(Fault%20Tolerance)/01-Disaster_Recovery_FHRP_Keepalived/img/FHRP_00.jpg)

# Группы протоколов FHRP

**- Протокол HSRP (Hot Standby Router/Redundancy Protocol)**

Является проприетарной разработкой инженеров Cisco. Здесь всё достаточно просто:

1. Берется какая-то группа физических маршрутизаторов, на них запускается специальный процесс HSRP под уникальным числовым идентификатором.
2. Исходя из значений приоритетов, выбирается ACTIVE-маршрутизатор, STANDBY-маршрутизаторы
3. Настраивается виртуальный IP-адрес, за который будет отвечать ACTIVE-маршрутизатор
4. Опционально: настраивается режим PREEMPT, аутентификация, etc

**Сущности домена HSRP и терминология**

- HSRP Active Router — устрой­ство, занимающееся обработкой, маршрутизацией легитимного трафика.
- HSRP Standby Router — устрой­ство, находящееся в режиме ожидания, которое ожи­дает отка­за активно­го мар­шру­тиза­тора. Пос­ле падения основно­го Active-роуте­ра, Standby-роутер возь­мет на себя гла­венс­тву­ющую роль и будет занимать­ся обя­зан­ностя­ми Active-роуте­ра;
- HSRP Group — груп­па устрой­ств одной HSRP-груп­пы, обес­печива­ют работу и отка­зоус­той­чивость логичес­кого мар­шру­тиза­тора;
- HSRP MAC Address — вир­туаль­ный MAC-адрес логичес­кого мар­шру­тиза­тора в домене HSRP;
- HSRP Virtual IP Address — это спе­циаль­ный вир­туаль­ный IP-адрес в груп­пе HSRP. Дан­ный IP-адрес будет шлю­зом по умол­чанию для конеч­ных хос­тов, исполь­зует­ся на самом логичес­ком мар­шру­тиза­торе.
- HSRP Preempt mode - опция, которая позволяет павшему ACTIVE-устройству (после его воскрешения) вернуть себе роль ACTIVE, после того когда его заменил один из STANDBY-маршрутизаторов (ситуация, когда была выполнена подмена ACTIVE-устройства, вышедшего из строя). По умолчанию, Preempt-режим в HSRP отключен.

**Скелет и механика работы HSRP**

HSRP реализован поверх стека протоколов TCP/IP, поэтому для трансляции служебной информации используется протокол транспортного уровня UDP под номером порта 1985. HSRP-маршрутизаторы в рамках одной логической группы обмениваются специальными пакетами приветствия "hello" каждые 3 секунды, однако, если в течении 10 секунд HSRP-маршрутизатор в рамках одной группы не получил пакет приветствия от своего HSRP-соседа, то он признает его "погибшим"

У данного протокола есть две версии и они отличаются следующими характеристиками:

- Количества групп (HSRPv1 предлагает до 255 групп, когда HSRPv2 может до 4096)
- MAC-адреса (HSRPv1 - 00:00:0c:07:ac:xx / HSRPv2 - 00:00:0C:9F:FX:XX) (XX - это номер группы HSRP)
- IP-адреса групповой рассылки (HSRPv1 - 224.0.0.2 / HSRPv2 - 224.0.0.102)
____
**- Протокол VRRP (Virtual Router Redundancy Protocol)**

Данный протокол разработан на основе феноменов протокола HSRP, вследствие чего имеет большие неприятности с патентами. Поэтому его "свободным" и "открытым" назвать нельзя. Но по крайней мере поддерживается всеми вендорами сетевого оборудования, т.е. использование VRRP в твоей сети позволяет тебе быть независимым от какой-либо экосистемы вендора.

**Скелет и механика работы VRRP**

Де-факто, если ты знаешь как работает HSRP, ты знаешь как работает и VRRP. Между HSRP и VRRP очень много общего, но отличительные характеристики для тебя обозначу:

- VRRP не реализован поверх стека протоколов TCP/IP. Данный протокол работает исключительно на сетевом уровне
- Его IP-адрес мультикастовой рассылки - 224.0.0.18
- Его идентификатор - 112
- Вторая версия VRRPv2 отличается поддержкой IPv4 и поддержкой аутентификации. Тип аутентификации в зависимости от вендора. Например, Cisco предлагает защитить VRRP с использованием MD5-аутентификации, когда MikroTik (RouterOS) предлагает AH-аутентификации (AH - это протокол из оперы IPSec'a)
- Третья версия - VRRPv3 отличается поддержкой IPv6, но лишается аутентификации.

VRRP-соседи в рамках одного домена отказоустойчивости обмениваются специальными пакетами приветствия, каждую секунду (своего рода hello time). Но также есть своего рода "dead timer" - если в течении 10 секунд пакета приветствия не будет - тот роутер от которого ожидался этот "hello" - выпадет из домена отказоустойчивости.

**Проблема возникновения псевдобалансировки**

Проблема заключается в том, что у протоколов HSRP и VRRP нет механизма балансировки нагрузки. При их использовании возникает псевдобалансировка, когда по умолчанию фактически пашет только одно устройство, когда остальные отдыхают и работают в режиме ожидания. Однако, вы можете просто раскидать ваши VLAN по логическим процессам HSRP/VRRP на уровне коммутаторов распределения (L3 свитчи) или на маршрутизаторов, когда будут создаваться логические VLAN-интерфейсы (802.1Q Encapsultation Moment)
____
**- Протокол GLBP (Gateway Load Balancing Protocol)**

Разработан инженерами Cisco Systems. Как и HSRP, данный протокол реализован поверх стека протоколов TCP/IP, поэтому для трансляции служебной информации используется протокол транспортного уровня UDP под номером порта 3222. GLBP-маршрутизаторы в рамках одной логической группы обмениваются специальными пакетами приветствия "hello" каждые 3 секунды, однако, если в течении 10 секунд GLBP-маршрутизатор в рамках одной группы не получил пакет приветствия от своего GLBP-соседа, то он признает его "погибшим". Однако, значения таймеров могут конфигурироваться в зависимости от нужд админа.

**Скелет и механика работы GLBP**

GLBP обеспечивает распределение нагрузки на несколько маршрутизаторов (шлюзов) используя один виртуальный IP-адрес и несколько виртуальных MAC-адресов. Каждый хост сконфигурирован с одинаковым виртуальным IP-адресом и все маршрутизаторы в виртуальной группе участвуют в передаче пакетов.

Работает гораздо иначе в отношении протоколов HSRP и VRRP, так как использует механизмы настоящей балансировки нагрузки, обозначу ниже:

- Host-Dependent. Тип балансировки нагрузки, использующийся в сети, где есть NAT. Host-Dependent гарантирует тот факт, что хосту вернется тот же MAC-адрес AVF-устройства, который использовался в раннем моменте времени, тем самым трансляции сконфигурированного NAT в отношении хоста разорваны не будут.
- Round-Robin. В данном режиме AVG-устройство раздает MAC-адреса членам AVF попеременно. Именно этот механизм используется по умолчанию
- Weight-based round-robin. Балансировка нагрузки на основе специальной метрики "Weight" (если переводить с английского - это вес)

**Сущности домена GLBP и терминология**

- AVG (Active Virtual Gateway) - устройство, которое является по сути батей всего логического домена GLBP. "Батя" указывает остальным маршрутизаторам как выполнять обработку легитимного трафика. Раздает MAC-адреса, ответственнен за ответы за ARP-запросы. Кстати говоря, в рамках одной группы GLBP, AVG-членов может быть только один маршрутизатор.
- AVF (Active Virtual Forwarder) - устройство в домене GLBP, которое занимается обработкой трафика. Их может быть несколько.
- GLBP Group - логическая группа GLBP, в которую входят физические маршрутизаторы. У каждой логической группы GLBP есть свой уникальный числовой идентификатор
- GLBP MAC - виртуальный MAC-адрес AVF-членов, раздаваемый существующим AVG-роутером.
- GLBP Virtual IP Address - IP-адрес, за который ответственнен AVG-маршрутизатор
- GLBP Preempt Mode - опция, позволяющая воскресшему AVG-устройству вернуть себе роль, после того, когда его подменил AVF, исходя из значений приоритетов. По умолчанию, в отношении AVG режим преемптинга отключен, когда для AVF-членов режим преемптинга включен (с задержкой до 30 секунд, но данное значение может конфигурироваться вручную)
- GLBP Weight - метрика, указывающая степень нагрузки на интерфейс устройства. Чем эта метрика больше, тем выше нагрузка на интерфейс маршрутизатора.
